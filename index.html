<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ship Update Analytics</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="wrap">
    <h2>Ship Update Analytics (Update=1 Only)</h2>

    <div class="card">
        <div class="row">
            <div class="input-group">
                <label>1. Select File</label>
                <input id="file" type="file" accept=".xlsx,.xls,.xlsm" />
            </div>
            <button id="btnParse">Load Data</button>
            <span id="status" class="status">Waiting for file...</span>
        </div>

        <hr style="border:0; border-top:1px solid #eee; margin: 15px 0;">

        <div class="row">
            <div class="input-group">
                <label>Sheet Name</label>
                <input id="sheetName" value="Log" />
            </div>
            
            <div class="input-group">
                <label>Ship Name Col</label>
                <select id="colShip"></select>
            </div>
            <div class="input-group">
                <label>Update Status Col</label>
                <select id="colUpdateStatus"></select>
            </div>
            <div class="input-group">
                <label>Update Date Col</label>
                <select id="colUpdateDate"></select>
            </div>
            <div class="input-group">
                <label>Category Col</label>
                <select id="colCategory"></select>
            </div>
        </div>

        <div class="row" style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
            <div class="input-group">
                <label>Filter by Ship</label>
                <select id="filterShip"><option value="">(All Ships)</option></select>
            </div>
            <div class="input-group">
                <label>Filter by Year</label>
                <select id="filterYear"><option value="">(All Years)</option></select>
            </div>
            <div style="font-size: 13px; color: #666; align-self: flex-end; margin-bottom: 10px;">
                ℹ️ Only records where <b>Update Column = 1</b> are shown.
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="panel">
            <h3>Daily Trend (Updates)</h3>
            <div class="chart-container"><canvas id="chartDaily"></canvas></div>
        </div>
        <div class="panel">
            <h3>Monthly Trend</h3>
            <div class="chart-container"><canvas id="chartMonthly"></canvas></div>
        </div>
        <div class="panel">
            <h3>Yearly Overview</h3>
            <div class="chart-container"><canvas id="chartYearly"></canvas></div>
        </div>
        <div class="panel">
            <h3>Category Distribution</h3>
            <div class="chart-container"><canvas id="chartCategory"></canvas></div>
        </div>
    </div>

    <pre id="diag">Diagnostics log...</pre>
</div>

<script src="https://cdn.bootcdn.net/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const $ = (id) => document.getElementById(id);
    let rawRows = [];
    let headers = [];
    
    // Chart instances
    let charts = { daily: null, monthly: null, yearly: null, category: null };

    function log(msg) {
        const d = $("diag");
        d.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
        d.scrollTop = d.scrollHeight;
    }

    function setStatus(msg, type) {
        const s = $("status");
        s.textContent = msg;
        s.className = "status " + (type === "ok" ? "ok" : "bad");
    }

    // Helper: Fill Select Box
    function fillSelect(id, items, defaultText = null) {
        const el = $(id);
        el.innerHTML = "";
        if (defaultText) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = defaultText;
            el.appendChild(opt);
        }
        items.forEach(item => {
            const opt = document.createElement("option");
            opt.value = item;
            opt.textContent = item;
            el.appendChild(opt);
        });
    }

    // Excel Date Parser
    function parseDate(val) {
        if (!val) return null;
        if (val instanceof Date) return isNaN(val) ? null : val;
        // Excel Serial
        if (typeof val === 'number') {
            return new Date(Math.round((val - 25569) * 86400 * 1000));
        }
        // Strings
        const str = String(val).trim();
        // Try YYYY-MM-DD or DD/MM/YYYY
        const d = new Date(str);
        if (!isNaN(d)) return d;
        return null;
    }

    // ------------------------------------------------------
    // Main Logic
    // ------------------------------------------------------

    async function parseFile() {
        const file = $("file").files[0];
        if (!file) { setStatus("Please select a file first", "bad"); return; }
        
        setStatus("Reading file...", "ok");
        log("Reading file: " + file.name);

        try {
            const buf = await file.arrayBuffer();
            const wb = XLSX.read(buf, { type: 'array' });
            
            const targetSheet = $("sheetName").value.trim().toLowerCase();
            const sheetName = wb.SheetNames.find(n => n.toLowerCase() === targetSheet) || 
                              wb.SheetNames.find(n => n.toLowerCase().includes(targetSheet));

            if (!sheetName) {
                setStatus("Sheet not found", "bad");
                log(`Error: Sheet '${targetSheet}' not found.`);
                return;
            }

            const ws = wb.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
            
            // Find Header Row (first row with >3 columns)
            const headerIdx = json.findIndex(row => row.filter(c => c).length >= 3);
            if (headerIdx === -1) throw new Error("Could not detect header row");

            headers = json[headerIdx].map(h => String(h || "").trim());
            rawRows = json.slice(headerIdx + 1).map(row => {
                let obj = {};
                headers.forEach((h, i) => obj[h] = row[i]);
                return obj;
            });

            log(`Parsed ${rawRows.length} rows. Mapping columns...`);

            // Auto-Map Columns
            const lowerHeaders = headers.map(h => h.toLowerCase());
            
            fillSelect("colShip", headers);
            $("colShip").value = headers[lowerHeaders.findIndex(h => h.includes("ship") || h.includes("vessel"))] || "";

            fillSelect("colUpdateStatus", headers);
            $("colUpdateStatus").value = headers[lowerHeaders.findIndex(h => h === "update" || h.includes("status"))] || "";

            fillSelect("colUpdateDate", headers);
            $("colUpdateDate").value = headers[lowerHeaders.findIndex(h => h.includes("update") && (h.includes("date") || h.includes("time")))] || "";

            fillSelect("colCategory", headers);
            $("colCategory").value = headers[lowerHeaders.findIndex(h => h.includes("category") || h.includes("type"))] || "";

            updateFilters();
            setStatus("File Loaded. Ready to analyze.", "ok");
            updateDashboard();

        } catch (e) {
            console.error(e);
            setStatus("Error: " + e.message, "bad");
        }
    }

    function updateFilters() {
        const shipCol = $("colShip").value;
        const dateCol = $("colUpdateDate").value;

        if (!shipCol || !dateCol) return;

        // Extract Ships
        const ships = [...new Set(rawRows.map(r => r[shipCol]).filter(v => v))].sort();
        fillSelect("filterShip", ships, "(All Ships)");

        // Extract Years from Update Date
        const years = new Set();
        rawRows.forEach(r => {
            const d = parseDate(r[dateCol]);
            if (d) years.add(d.getFullYear());
        });
        fillSelect("filterYear", [...years].sort(), "(All Years)");
    }

    function getProcessedData() {
        const colShip = $("colShip").value;
        const colUpdate = $("colUpdateStatus").value;
        const colDate = $("colUpdateDate").value;
        const colCat = $("colCategory").value;
        
        const filterShip = $("filterShip").value;
        const filterYear = $("filterYear").value;

        if (!colShip || !colUpdate || !colDate) {
            log("Missing column mapping. Please select columns.");
            return [];
        }

        let validCount = 0;
        let updateOneCount = 0;

        const data = rawRows.filter(row => {
            // 1. Strict Update = 1 Check
            // Handle number 1 or string "1"
            const updateVal = row[colUpdate];
            if (String(updateVal).trim() !== "1") return false;
            updateOneCount++;

            // 2. Filter by Ship
            if (filterShip && row[colShip] !== filterShip) return false;

            // 3. Parse Date
            const d = parseDate(row[colDate]);
            if (!d) return false;

            // 4. Filter by Year
            if (filterYear && String(d.getFullYear()) !== filterYear) return false;

            // Attach parsed date to row object for easier grouping
            row._parsedDate = d;
            return true;
        });

        log(`Rows with Update=1: ${updateOneCount}. Final Dataset after filters: ${data.length}`);
        return data;
    }

    function destroyChart(key) {
        if (charts[key]) {
            charts[key].destroy();
            charts[key] = null;
        }
    }

    function updateDashboard() {
        const data = getProcessedData();
        const colCat = $("colCategory").value;

        // Prepare Aggregates
        const aggDaily = {};
        const aggMonthly = {};
        const aggYearly = {};
        const aggCat = {};

        data.forEach(row => {
            const d = row._parsedDate;
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, "0");
            const day = String(d.getDate()).padStart(2, "0");

            // Daily Key: YYYY-MM-DD
            const kDaily = `${y}-${m}-${day}`;
            aggDaily[kDaily] = (aggDaily[kDaily] || 0) + 1;

            // Monthly Key: YYYY-MM
            const kMonthly = `${y}-${m}`;
            aggMonthly[kMonthly] = (aggMonthly[kMonthly] || 0) + 1;

            // Yearly Key: YYYY
            const kYearly = `${y}`;
            aggYearly[kYearly] = (aggYearly[kYearly] || 0) + 1;

            // Category
            const cat = row[colCat] || "Uncategorized";
            aggCat[cat] = (aggCat[cat] || 0) + 1;
        });

        // --- Render Daily Chart ---
        destroyChart('daily');
        const dailyLabels = Object.keys(aggDaily).sort();
        charts.daily = new Chart($("chartDaily"), {
            type: 'line',
            data: {
                labels: dailyLabels,
                datasets: [{
                    label: 'Daily Updates',
                    data: dailyLabels.map(k => aggDaily[k]),
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0,123,255,0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // --- Render Monthly Chart ---
        destroyChart('monthly');
        const monthlyLabels = Object.keys(aggMonthly).sort();
        charts.monthly = new Chart($("chartMonthly"), {
            type: 'bar',
            data: {
                labels: monthlyLabels,
                datasets: [{
                    label: 'Monthly Updates',
                    data: monthlyLabels.map(k => aggMonthly[k]),
                    backgroundColor: '#17a2b8'
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // --- Render Yearly Chart ---
        destroyChart('yearly');
        const yearlyLabels = Object.keys(aggYearly).sort();
        charts.yearly = new Chart($("chartYearly"), {
            type: 'bar',
            data: {
                labels: yearlyLabels,
                datasets: [{
                    label: 'Yearly Updates',
                    data: yearlyLabels.map(k => aggYearly[k]),
                    backgroundColor: '#ffc107'
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // --- Render Category Chart ---
        destroyChart('category');
        const catEntries = Object.entries(aggCat).sort((a,b) => b[1] - a[1]); // Sort Desc
        charts.category = new Chart($("chartCategory"), {
            type: 'bar',
            data: {
                labels: catEntries.map(e => e[0]),
                datasets: [{
                    label: 'Updates by Category',
                    data: catEntries.map(e => e[1]),
                    backgroundColor: '#28a745'
                }]
            },
            options: { 
                indexAxis: 'y', 
                responsive: true, 
                maintainAspectRatio: false 
            }
        });
    }

    // Events
    $("btnParse").addEventListener("click", parseFile);
    
    // Auto-update when dropdowns change
    ["filterShip", "filterYear", "colShip", "colUpdateStatus", "colUpdateDate", "colCategory"]
        .forEach(id => $(id).addEventListener("change", updateDashboard));

</script>
</body>
</html>
