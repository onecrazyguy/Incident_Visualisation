<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>Log Visualizer Pro</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="wrap">
  <h2>Log Data Dashboard</h2>

  <div class="card">
    <div class="row">
      <input id="file" type="file" accept=".xlsx,.xls,.xlsm" />
      <button id="btnParse">解析 Excel</button>
      <button id="btnDraw">刷新图表</button>
      <span id="status" class="status">等待文件...</span>
    </div>

    <div class="row">
      <label>工作表名:</label>
      <input id="sheetName" value="Log" style="width:100px" />

      <label>日期列:</label>
      <select id="dateCol"></select>

      <label>分类列:</label>
      <select id="catCol"></select>

      <label>年份:</label>
      <select id="year"></select>

      <label>月份范围:</label>
      <select id="mFrom"></select> 到 <select id="mTo"></select>

      <label>分类筛选:</label>
      <select id="catFilter"></select>

      <label style="background: #e7f3ff; padding: 5px 10px; border-radius: 6px; cursor: pointer;">
        <input type="checkbox" id="updateOnly" /> 只统计 Update=1
      </label>
    </div>
  </div>

  <div class="grid">
    <div class="panel">
      <h3>每月数据分布</h3>
      <div class="chart-box">
        <canvas id="c1"></canvas>
      </div>
    </div>
    <div class="panel">
      <h3>分类排行 (Top 20)</h3>
      <div class="chart-box">
        <canvas id="c2"></canvas>
      </div>
    </div>
  </div>

  <div class="grid" style="margin-top:20px;">
    <div>
      <h4>数据预览</h4>
      <pre id="preview">尚未加载数据</pre>
    </div>
    <div>
      <h4>运行日志</h4>
      <pre id="diag">等待操作...</pre>
    </div>
  </div>
</div>

<script src="https://cdn.bootcdn.net/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/** * 应用逻辑 
 */
const $ = (id) => document.getElementById(id);

let rawRows = [];
let headers = [];
let chart1 = null;
let chart2 = null;

// 通用消息显示
function showStatus(msg, isOk) {
    $("status").innerHTML = (isOk ? "✅ " : "❌ ") + msg;
    $("status").className = "status " + (isOk ? "ok" : "bad");
}

function logDiag(msg) {
    const d = $("diag");
    d.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
    d.scrollTop = d.scrollHeight;
}

// 日期解析（处理 Excel 数值及多种字符串格式）
function parseExcelDate(val) {
    if (!val) return null;
    if (val instanceof Date) return isNaN(val) ? null : val;
    
    if (typeof val === 'number') {
        return new Date(Math.round((val - 25569) * 86400 * 1000));
    }
    
    const s = String(val).trim().replace(/\bLT\b/ig, "");
    const parts = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
    if (parts) {
        return new Date(parts[3], parts[2] - 1, parts[1]);
    }
    return null;
}

function destroyCharts() {
    if (chart1) chart1.destroy();
    if (chart2) chart2.destroy();
    chart1 = null; chart2 = null;
}

// 核心数据过滤
function getFilteredData() {
    const dCol = $("dateCol").value;
    const cCol = $("catCol").value;
    const yr = $("year").value;
    const mf = $("mFrom").value;
    const mt = $("mTo").value;
    const cf = $("catFilter").value;
    const upOnly = $("updateOnly").checked;

    if (!dCol) return [];

    return rawRows.filter(r => {
        // 1. 日期解析
        const d = parseExcelDate(r[dCol]);
        if (!d) return false;

        const yStr = String(d.getFullYear());
        const mStr = String(d.getMonth() + 1).padStart(2, '0');

        // 2. 基础过滤条件
        if (yr && yStr !== yr) return false;
        if (mStr < mf || mStr > mt) return false;
        if (cf && cCol && String(r[cCol]) !== cf) return false;

        // 3. Update=1 逻辑
        if (upOnly) {
            const upKey = Object.keys(r).find(k => k.toLowerCase() === 'update');
            if (!upKey || String(r[upKey]) !== "1") return false;
        }

        r._dObj = d; // 暂存日期对象供绘图使用
        return true;
    });
}

function drawCharts() {
    const filtered = getFilteredData();
    logDiag(`正在绘图，符合条件行数: ${filtered.length}`);
    
    destroyCharts();
    if (filtered.length === 0) {
        showStatus("筛选后无可用数据", false);
        return;
    }

    // --- 逻辑：按月统计 ---
    const monthMap = {};
    filtered.forEach(r => {
        const key = `${r._dObj.getFullYear()}-${String(r._dObj.getMonth()+1).padStart(2,'0')}`;
        monthMap[key] = (monthMap[key] || 0) + 1;
    });
    const sortedMonths = Object.keys(monthMap).sort();

    // --- 逻辑：按分类统计 ---
    const catCol = $("catCol").value;
    const catMap = {};
    if (catCol) {
        filtered.forEach(r => {
            const val = String(r[catCol] || "未分类");
            catMap[val] = (catMap[val] || 0) + 1;
        });
    }
    const topCats = Object.entries(catMap).sort((a,b) => b[1]-a[1]).slice(0, 20);

    // 渲染图表 1
    chart1 = new Chart($("c1"), {
        type: 'bar',
        data: {
            labels: sortedMonths,
            datasets: [{ label: '记录数', data: sortedMonths.map(m => monthMap[m]), backgroundColor: '#3498db' }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    // 渲染图表 2
    chart2 = new Chart($("c2"), {
        type: 'bar',
        data: {
            labels: topCats.map(x => x[0]),
            datasets: [{ label: '记录数', data: topCats.map(x => x[1]), backgroundColor: '#2ecc71' }]
        },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false }
    });

    showStatus(`更新完成 (${filtered.length} 条记录)`, true);
}

async function parseFile() {
    const file = $("file").files[0];
    if (!file) { showStatus("未选择文件", false); return; }

    logDiag(`读取文件: ${file.name}`);
    try {
        const data = await file.arrayBuffer();
        const wb = XLSX.read(data, { type: 'array' });
        
        const targetSheet = $("sheetName").value.trim().toLowerCase();
        const realName = wb.SheetNames.find(n => n.toLowerCase() === targetSheet) || 
                         wb.SheetNames.find(n => n.toLowerCase().includes(targetSheet));

        if (!realName) { showStatus("找不到指定的 Sheet", false); return; }

        const grid = XLSX.utils.sheet_to_json(wb.Sheets[realName], { header: 1 });
        const hIndex = grid.findIndex(r => r.filter(c => c !== "").length >= 3);
        
        if (hIndex === -1) { showStatus("找不到有效的表格结构", false); return; }

        headers = grid[hIndex].map(h => String(h || "").trim());
        rawRows = grid.slice(hIndex + 1).map(row => {
            let obj = {};
            headers.forEach((h, i) => obj[h] = row[i] ?? "");
            return obj;
        }).filter(r => Object.values(r).some(v => v !== ""));

        // 更新下拉菜单
        const dGuess = headers.find(h => /date|时间|日期/i.test(h)) || headers[0];
        const cGuess = headers.find(h => /category|type|分类|类别/i.test(h)) || "";

        fillSelect($("dateCol"), headers);
        $("dateCol").value = dGuess;

        fillSelect($("catCol"), headers, "-- 不统计分类 --");
        if (cGuess) $("catCol").value = cGuess;

        const years = [...new Set(rawRows.map(r => {
            const d = parseExcelDate(r[dGuess]);
            return d ? d.getFullYear() : null;
        }).filter(y => y))].sort();
        fillSelect($("year"), years, "所有年份");

        const months = ["01","02","03","04","05","06","07","08","09","10","11","12"];
        fillSelect($("mFrom"), months); fillSelect($("mTo"), months);
        $("mFrom").value = "01"; $("mTo").value = "12";

        $("preview").textContent = JSON.stringify(rawRows.slice(0, 5), null, 2);
        logDiag(`成功加载 ${rawRows.length} 行数据`);
        drawCharts();
    } catch (e) {
        logDiag(`错误: ${e.message}`);
        showStatus("解析失败", false);
    }
}

function fillSelect(el, list, emptyLabel) {
    el.innerHTML = "";
    if (emptyLabel) el.options.add(new Option(emptyLabel, ""));
    list.forEach(v => el.options.add(new Option(v, v)));
}

// 事件监听
$("btnParse").addEventListener("click", parseFile);
$("btnDraw").addEventListener("click", drawCharts);
$("dateCol").addEventListener("change", drawCharts);
$("year").addEventListener("change", drawCharts);
$("mFrom").addEventListener("change", drawCharts);
$("mTo").addEventListener("change", drawCharts);
$("updateOnly").addEventListener("change", drawCharts);
$("catCol").addEventListener("change", () => {
    const c = $("catCol").value;
    const list = c ? [...new Set(rawRows.map(r => String(r[c] || "")))].sort() : [];
    fillSelect($("catFilter"), list, "所有分类");
    drawCharts();
});
$("catFilter").addEventListener("change", drawCharts);

</script>
</body>
</html>
